<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini-Webshop</title>
  <style>
    :root {
      --field-max: 420px;
      --gap: 0.8rem;
      --border: #ccc;
      --muted: #666;
      --btn: #0077cc;
      --btn-hover: #005fa3;
      --btn-ghost-bg: #f4f6f8;
      --btn-ghost-border: #d9dee3;
      --added: #dff4ff;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 1rem; }
    h1 { margin-bottom: 1rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 1rem; }
    .card { border: 1px solid var(--border); border-radius: 12px; padding: 1rem; box-shadow: 2px 2px 6px rgba(0,0,0,.06); background: #fff; transition: box-shadow .2s, background-color .2s; }
    .card.added { box-shadow: 0 0 0 2px #8cd3ff inset, 2px 2px 10px rgba(0,0,0,.12); background: var(--added); }
    .row { display: flex; align-items: center; gap: 0.5rem; }
    .row.space { justify-content: space-between; flex-wrap: wrap; }
    .btn { background: var(--btn); color: white; border: none; padding: 0.55rem 0.95rem; border-radius: 8px; cursor: pointer; }
    .btn:hover { background: var(--btn-hover); }
    .btn.ghost { background: var(--btn-ghost-bg); color: #222; border: 1px solid var(--btn-ghost-border); }
    .btn.square { width: 44px; height: 44px; padding: 0; display: inline-flex; align-items: center; justify-content: center; font-size: 22px; line-height: 1; border-radius: 10px; }
    .muted { color: var(--muted); font-size: 0.9em; }
    .danger { color: #b00020; }

    /* Formularelemente einheitlich & mobil-optimiert */
    select, input, textarea {
      width: 100%;
      max-width: var(--field-max);
      padding: .6rem .8rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-bottom: var(--gap);
      box-sizing: border-box;
      display: block;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-color: #fff;
      font-size: 16px; /* iOS: verhindert Zoom beim Fokus */
    }
    /* Kleines ▼-Icon im Select */
    select {
      background:
        white
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='14' height='10' viewBox='0 0 14 10'><path d='M2 2l5 5 5-5' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round'/></svg>")
        no-repeat right .8rem center / 14px 10px;
      padding-right: 2rem;
    }

    /* Mengensteuerung (−  [Anzahl]  +) */
    .qty { display: inline-flex; align-items: center; gap: 0.4rem; }
    .qty .num {
      min-width: 2.2em; text-align: center; font-weight: 600;
      padding: .4rem .6rem; border: 1px solid var(--btn-ghost-border);
      border-radius: 8px; background: #fff;
    }

    /* Warenkorb-Zeile */
    .cart-row { display: grid; grid-template-columns: auto 1fr auto auto; gap: .6rem; align-items: center; padding: .4rem 0; }
    .cart-row .name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .cart-remove { background: #fff; color: #c62828; border: 1px solid #ef9a9a; }
    .cart-remove:hover { background: #ffeaea; }
    @media (max-width: 420px) {
      .cart-row { grid-template-columns: 1fr auto; grid-row-gap: .4rem; }
      .cart-row .name { grid-column: 1 / -1; }
      .cart-row .sum { justify-self: end; }
    }
  </style>

  <script>
    // Cloudflare-Worker-URL für Online-Zahlung (Karte/Paypal)
    window.CONFIG = {
      ENDPOINT_URL: "https://wild-cloud-edf6.f-braun.workers.dev"
    };
  </script>
</head>
<body>
<h1>Mini-Webshop</h1>

<div id="products" class="grid"></div>

<h2>Warenkorb</h2>
<div id="cart"></div>

<h2>Zusammenfassung</h2>
<div class="row"><div>Netto</div><div id="t-net">0,00 €</div></div>
<div class="row"><div>MwSt.</div><div id="t-vat">0,00 €</div></div>
<div class="row"><strong>Brutto</strong><strong id="t-gross">0,00 €</strong></div>

<h2>Kunde &amp; Zahlung</h2>
<div><input id="c-name" placeholder="Name" autocomplete="name"></div>
<div><input id="c-email" placeholder="E-Mail" type="email" autocomplete="email"></div>
<div>
  <select id="c-room" aria-label="Zimmer">
    <option value="">Zimmer wählen</option>
  </select>
</div>
<div><textarea id="c-notes" placeholder="Hinweise" rows="3"></textarea></div>
<div>
  <select id="c-pay" aria-label="Zahlungsart">
    <option>Bar</option>
    <option>Zimmerrechnung</option>
    <option>Karte</option>
    <option>Paypal</option>
  </select>
</div>
<button id="submit" class="btn">Bestellung abschicken</button>
<div id="msg" class="muted"></div>

<script>
const fmt = n => (n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
let products=[], cart=[];

// Produkte laden
fetch("./products.json")
  .then(r => r.json())
  .then(data => { products = data; render(); })
  .catch(err => { document.getElementById('products').textContent = "Fehler beim Laden: "+err; });

// Zimmer laden
fetch("./zimmer.json")
  .then(r => r.json())
  .then(data => {
    const sel = document.getElementById('c-room');
    data.forEach(z => {
      const opt = document.createElement('option');
      opt.value = z.name;
      opt.textContent = z.name;
      sel.appendChild(opt);
    });
  });

// --- Helpers ---
function inCart(id){ return cart.find(i=>i.id==id); }

function smoothKeepVisible(el){
  // Auf schmalen Geräten: so scrollen, dass die Karte gerade noch sichtbar bleibt
  if (window.innerWidth > 640 || !el) return;
  const rect = el.getBoundingClientRect();
  const overflowBottom = rect.bottom - (window.innerHeight - 12);
  if (overflowBottom > 0) {
    window.scrollBy({ top: overflowBottom, behavior: 'smooth' });
  } else if (rect.top < 0) {
    el.scrollIntoView({ block: 'start', behavior: 'smooth' });
  }
}

function flashAdded(el){
  if(!el) return;
  el.classList.add('added');
  setTimeout(()=>el.classList.remove('added'), 800);
}

function addToCart(p, delta=1, el=null){
  const ex = inCart(p.id);
  if(ex){ ex.qty = Math.max(0, ex.qty + delta); }
  else if(delta > 0){ cart.push({id:p.id, name:p.name, price_gross:p.price_gross, vat_rate:p.vat_rate, qty:delta}); }
  cart = cart.filter(i=>i.qty>0);
  render();
  // visuelles Feedback + Mobile-Scroll
  flashAdded(el);
  smoothKeepVisible(el);
}

function setQty(id, q){
  const it = inCart(id);
  if(!it) return;
  it.qty = Math.max(0, Number(q)||0);
  cart = cart.filter(i=>i.qty>0);
  render();
}

function totals(){
  const gross=cart.reduce((s,i)=>s+i.price_gross*i.qty,0);
  const vatSum=cart.reduce((s,i)=>{
    const rate=Number(i.vat_rate||0)/100;
    const base=i.price_gross;
    return s+(base-(base/(1+rate)))*i.qty;
  },0);
  const net=gross-vatSum;
  return {items: cart.slice(), net, vatSum, gross};
}

function render(){
  // Produktliste
  const list=document.getElementById('products');
  list.innerHTML='';
  products.forEach(p=>{
    const card=document.createElement('div');
    card.className='card';

    const title=document.createElement('div');
    title.className='row space';
    const name=document.createElement('div');
    name.textContent=p.name;
    const price=document.createElement('div');
    price.className='muted';
    price.textContent=fmt(p.price_gross)+" €";
    title.appendChild(name);
    title.appendChild(price);

    const spacer=document.createElement('div');
    spacer.style.height="0.8rem";

    const btn=document.createElement('button');
    btn.className='btn';
    btn.textContent='Hinzufügen';
    btn.onclick=()=>addToCart(p, 1, card);

    card.appendChild(title);
    card.appendChild(spacer);
    card.appendChild(btn);
    list.appendChild(card);
  });

  // Warenkorb
  const cartEl=document.getElementById('cart');
  cartEl.innerHTML='';
  if(cart.length===0){
    const m=document.createElement('div');
    m.className='muted';
    m.textContent='Noch keine Artikel.';
    cartEl.appendChild(m);
  }
  cart.forEach(i=>{
    const row=document.createElement('div');
    row.className='cart-row';

    const remove=document.createElement('button');
    remove.className='btn square cart-remove';
    remove.setAttribute('aria-label','Entfernen');
    remove.textContent='✕';
    remove.onclick=()=>{ cart = cart.filter(a=>a.id!==i.id); render(); };

    const nm=document.createElement('div');
    nm.className='name';
    nm.textContent=i.name;

    const qtyWrap = document.createElement('div');
    qtyWrap.className='qty';
    const minus = document.createElement('button');
    minus.className='btn ghost square';
    minus.setAttribute('aria-label','Menge verringern');
    minus.textContent='−';
    minus.onclick=()=>setQty(i.id, i.qty-1);
    const num = document.createElement('div');
    num.className='num';
    num.textContent = i.qty;
    const plus = document.createElement('button');
    plus.className='btn ghost square';
    plus.setAttribute('aria-label','Menge erhöhen');
    plus.textContent='+';
    plus.onclick=()=>setQty(i.id, i.qty+1);
    qtyWrap.appendChild(minus);
    qtyWrap.appendChild(num);
    qtyWrap.appendChild(plus);

    const sum=document.createElement('div');
    sum.className='sum';
    sum.textContent = fmt(i.qty*i.price_gross)+" €";

    row.appendChild(remove);
    row.appendChild(nm);
    row.appendChild(qtyWrap);
    row.appendChild(sum);
    cartEl.appendChild(row);
  });

  const t=totals();
  document.getElementById('t-net').textContent=fmt(t.net)+" €";
  document.getElementById('t-vat').textContent=fmt(t.vatSum)+" €";
  document.getElementById('t-gross').textContent=fmt(t.gross)+" €";
}

// Submit
document.getElementById('submit').addEventListener('click', async ()=>{
  const name=document.getElementById('c-name').value.trim();
  const email=document.getElementById('c-email').value.trim();
  const room=document.getElementById('c-room').value;
  const notes=document.getElementById('c-notes').value.trim();
  const pay=document.getElementById('c-pay').value;
  const msg=document.getElementById('msg');

  const t=totals();
  if(!t.items.length){
    msg.textContent="Bitte mindestens einen Artikel wählen."; msg.className="muted danger"; return;
  }

  // Fall A: Bar/Zimmerrechnung -> an Worker senden, dort Baserow schreiben -> n8n wird via Baserow-Webhook getriggert
if (pay==='Bar' || pay==='Zimmerrechnung') {
  msg.textContent = "Sende Bestellung …";
  try{
    const res = await fetch(window.CONFIG.ENDPOINT_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        cart: t.items.map(i=>({ id:i.id, name:i.name, qty:i.qty, price_gross:i.price_gross, vat_rate:i.vat_rate })),
        totals: { net:t.net, vatSum:t.vatSum, gross:t.gross },
        customer: { name, email, room, notes, pay },
        currency: 'EUR',
        source: 'mini-webshop'
      })
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(data.error || ('HTTP '+res.status));
    // Optional: lokale Kopie für thankyou.html
    localStorage.setItem('lastOrder', JSON.stringify({
      items: t.items,
      totals: { net: t.net, vatSum: t.vatSum, gross: t.gross },
      customer: { name, email, room, notes, pay }
    }));
    msg.textContent = "Bestellung übermittelt. Du erhältst gleich eine Bestätigung per E-Mail.";
    msg.className = "muted";
    // Warenkorb leeren
    cart = [];
    render();
    return;
  }catch(e){
    msg.textContent='Fehler: '+(e.message||e);
    msg.className='muted danger';
    return;
  }
}

  // Fall B: Online-Zahlung (Karte/Paypal) -> Worker (Mollie)
  if (!window.CONFIG.ENDPOINT_URL) {
    msg.textContent="Online-Zahlung noch nicht konfiguriert (ENDPOINT_URL fehlt).";
    msg.className="muted danger";
    return;
  }

  msg.textContent="Leite zur Zahlung weiter…";
  msg.className="muted";

  try{
    const res = await fetch(window.CONFIG.ENDPOINT_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        cart: t.items.map(i=>({ id:i.id, name:i.name, qty:i.qty, price_gross:i.price_gross, vat_rate:i.vat_rate })),
        totals: { net:t.net, vatSum:t.vatSum, gross:t.gross },
        customer: { name, email, room, notes, pay },
        currency: 'EUR',
        source: 'mini-webshop'
      })
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(data.error || ('HTTP '+res.status));
    if (data.checkoutUrl) {
      // Bestellung lokal speichern für thankyou.html
      localStorage.setItem('lastOrder', JSON.stringify({
        items: t.items,
        totals: { net: t.net, vatSum: t.vatSum, gross: t.gross },
        customer: { name, email, room, notes, pay }
      }));
      window.location.href = data.checkoutUrl;
    } else {
      throw new Error('Keine checkoutUrl vom Server erhalten.');
    }
  }catch(e){
    msg.textContent='Fehler bei Online-Zahlung: '+(e.message||e);
    msg.className='muted danger';
  }
});
</script>
</body>
</html>
