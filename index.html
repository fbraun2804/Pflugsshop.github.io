<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini-Webshop</title>
  <style>
    body { font-family: sans-serif; margin: 1rem; }
    h1 { margin-bottom: 1rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 1rem; }
    .card { border: 1px solid #ccc; border-radius: 12px; padding: 1rem; box-shadow: 2px 2px 6px rgba(0,0,0,.1); }
    .row { display: flex; align-items: center; gap: 0.5rem; }
    .row.space { justify-content: space-between; }
    .btn { background: #0077cc; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; }
    .btn:hover { background: #005fa3; }
    img { display: block; margin-bottom: 0.5rem; }
    .muted { color: #666; font-size: 0.9em; }
    .danger { color: red; }
  </style>
</head>
<body>
<h1>Mini-Webshop</h1>

<div id="products-status">wird geladen…</div>
<div id="products" class="grid"></div>

<h2>Warenkorb</h2>
<div id="cart"></div>

<h2>Zusammenfassung</h2>
<div class="row"><div>Netto</div><div id="t-net">0,00 €</div></div>
<div class="row"><div>MwSt.</div><div id="t-vat">0,00 €</div></div>
<div class="row"><strong>Brutto</strong><strong id="t-gross">0,00 €</strong></div>

<h2>Kunde &amp; Zahlung</h2>
<div><input id="c-name" placeholder="Name"></div>
<div><input id="c-email" placeholder="E-Mail"></div>
<div><input id="c-room" placeholder="Zimmer"></div>
<div><textarea id="c-notes" placeholder="Hinweise"></textarea></div>
<div>
  <select id="c-pay">
    <option>Bar</option>
    <option>Zimmerrechnung</option>
    <option>Karte</option>
    <option>Paypal</option>
  </select>
</div>
<button id="submit" class="btn">Bestellung abschicken</button>
<div id="msg" class="muted"></div>

<script>
const fmt = n => (n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
let products=[], cart=[];

// Produkte laden
fetch("./products.json")
  .then(r => r.json())
  .then(data => {
    products = data;
    document.getElementById('products-status').textContent = products.length+" Artikel geladen";
    render();
  })
  .catch(err => {
    document.getElementById('products-status').textContent = "Fehler beim Laden: "+err;
  });

function addToCart(p){
  const ex = cart.find(i=>i.id==p.id);
  if(ex){ ex.qty+=1; } else {
    cart.push({id:p.id, name:p.name, price_gross:p.price_gross, vat_rate:p.vat_rate, qty:1});
  }
  render();
}
function changeQty(id,q){
  const it = cart.find(i=>i.id==id);
  if(!it) return;
  it.qty=Math.max(0,Number(q)||0);
  cart=cart.filter(i=>i.qty>0);
  render();
}
function totals(){
  const gross=cart.reduce((s,i)=>s+i.price_gross*i.qty,0);
  const vatSum=cart.reduce((s,i)=>{
    const rate=Number(i.vat_rate||0)/100;
    const base=i.price_gross;
    return s+(base-(base/(1+rate)))*i.qty;
  },0);
  const net=gross-vatSum;
  return {net,vatSum,gross};
}
function render(){
  const list=document.getElementById('products');
  list.innerHTML='';
  products.forEach(p=>{
    const card=document.createElement('div');
    card.className='card';
    if(p.image){
      const img=document.createElement('img');
      img.src=p.image;
      img.alt=p.name;
      img.style.maxWidth='100%';
      img.style.borderRadius='8px';
      card.appendChild(img);
    }
    const title=document.createElement('div');
    title.className='row space';
    const name=document.createElement('div');
    name.textContent=p.name;
    const price=document.createElement('div');
    price.className='muted';
    price.textContent=fmt(p.price_gross)+" €";
    title.appendChild(name);
    title.appendChild(price);
    const btn=document.createElement('button');
    btn.className='btn';
    btn.textContent='Hinzufügen';
    btn.onclick=()=>addToCart(p);
    card.appendChild(title);
    card.appendChild(btn);
    list.appendChild(card);
  });
  const cartEl=document.getElementById('cart');
  cartEl.innerHTML='';
  if(cart.length===0){
    const m=document.createElement('div');
    m.className='muted';
    m.textContent='Noch keine Artikel.';
    cartEl.appendChild(m);
  }
  cart.forEach(i=>{
    const row=document.createElement('div');
    row.className='row';
    const x=document.createElement('button');
    x.className='btn'; x.textContent='X';
    x.onclick=()=>{cart=cart.filter(a=>a.id!==i.id); render();};
    const name=document.createElement('div'); name.style.flex='1'; name.textContent=i.name;
    const qty=document.createElement('input'); qty.type='number'; qty.min='0'; qty.value=i.qty;
    qty.oninput=e=>changeQty(i.id,e.target.value);
    const sum=document.createElement('div'); sum.textContent=fmt(i.qty*i.price_gross)+" €";
    row.appendChild(x); row.appendChild(name); row.appendChild(qty); row.appendChild(sum);
    cartEl.appendChild(row);
  });
  const t=totals();
  document.getElementById('t-net').textContent=fmt(t.net)+" €";
  document.getElementById('t-vat').textContent=fmt(t.vatSum)+" €";
  document.getElementById('t-gross').textContent=fmt(t.gross)+" €";
}

document.getElementById('submit').addEventListener('click',()=>{
  const name=document.getElementById('c-name').value.trim();
  const email=document.getElementById('c-email').value.trim();
  const room=document.getElementById('c-room').value.trim();
  const notes=document.getElementById('c-notes').value.trim();
  const pay=document.getElementById('c-pay').value;
  const msg=document.getElementById('msg');
  if(!cart.length){
    msg.textContent="Bitte mindestens einen Artikel wählen."; msg.className="muted danger"; return;
  }
  const lines=cart.map(i=>`- ${i.qty}× ${i.name} (${fmt(i.price_gross)} €)`).join('%0D%0A');
  const details=[
    `Name: ${encodeURIComponent(name)}`,
    `E-Mail: ${encodeURIComponent(email)}`,
    `Zimmer: ${encodeURIComponent(room)}`,
    `Hinweise: ${encodeURIComponent(notes)}`,
    `Zahlart: ${encodeURIComponent(pay)}`,
    '', 'Positionen:', lines,
    '', `Netto: ${fmt(totals().net)} €`,
    `MwSt.: ${fmt(totals().vatSum)} €`,
    `Brutto: ${fmt(totals().gross)} €`
  ].join('%0D%0A');
  const mailto=`mailto:?subject=${encodeURIComponent('Bestellung Mini-Webshop')}&body=${details}`;
  window.location.href=mailto;
  msg.textContent="E-Mail-Entwurf geöffnet. Bitte Versand im Mailprogramm bestätigen.";
  msg.className="muted";
});
</script>
</body>
</html>
